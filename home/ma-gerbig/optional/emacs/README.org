:DOC-CONFIG:
# Tangle by default to init.el, which is the most common case
#+PROPERTY: header-args:emacs-lisp :tangle init.el
#+startup: fold
:END:

#+title: Emacs Configuration
#+author: Marc-Andre Gerbig

This is my personal GNU Emacs configuration file, inspired by a bunch of resources I’ve found online.
The =early-init.el= and =init.el= files are generated from this =*.org= document with =C-c C-v t=.

* Credits
| Name             | URL                                          |
|------------------+----------------------------------------------|
| Doom Emacs       | https://github.com/hlissner/doom-emacs       |
| Emmet            | https://github.com/librephoenix/nixos-config |
| Norman Walsh     | https://gitlab.com/ndw/dotfiles              |
| Protesilaos      | https://protesilaos.com/emacs/dotemacs       |
| Radon Rosborough | https://github.com/raxod502/radian           |
| SystemCrafter    | https://github.com/daviwil/dotfiles          |
| Zzamboni         | https://github.com/zzamboni/dot-doom/        |

* Early System Configuration (=early-init.el=)
:PROPERTIES:
:header-args:emacs-lisp: :tangle early-init.el
:END:
#+begin_quote
Emacs 27.1 introduced =early-init.el=, which is run before =init.el=, before package and UI initialization happens, and before site files are loaded.
#+end_quote

** File Headers
We start by simply defining the standard headers used by the two files.
These headers contain either some Emacs-LISP relevant indicators like =lexical-binding=, or instructions about the contents of the file.
#+html: <details><summary>early-init.el</summary>
#+begin_src emacs-lisp
  ;;; early-init.el -*- lexical-binding: t -*-
  ;; DO NOT EDIT THIS FILE DIRECTLY
  ;; This is a file generated from a literate programing source file located at
  ;; https://github.com/Deathlord89/nixos-config/blob/main/home/ma-gerbig/optional/emacs/README.org
  ;; You should make any changes there and regenerate it from Emacs org-mode
  ;; using org-babel-tangle (C-c C-v t)
#+end_src
#+html: </details>

#+html: <details><summary>init.el</summary>
#+begin_src emacs-lisp :tangle init.el
  ;;; early-init.el -*- lexical-binding: t -*-

  ;; DO NOT EDIT THIS FILE DIRECTLY
  ;; This is a file generated from a literate programing source file located at
  ;; https://github.com/Deathlord89/nixos-config/blob/main/home/ma-gerbig/optional/emacs/README.org
  ;; You should make any changes there and regenerate it from Emacs org-mode
  ;; using org-babel-tangle (C-c C-v t)
#+end_src
#+html: </details>

** Garbage Collection
A big contributor to startup times is garbage collection.
We up the gc threshold to temporarily prevent it from running, then reset it later by enabling =gcmh-mode=.
Not resetting it will cause stuttering/freezes.
#+begin_src emacs-lisp
  (setq gc-cons-threshold most-positive-fixnum ; 2^61 bytes
        gc-cons-percentage 0.6)
#+end_src

Calculate the maximale available memory in KB while the garbage collection is deactivated.
We use this later for the =lsp-memory-limit=. 
#+begin_src emacs-lisp
  (defvar total-memory (string-to-number (shell-command-to-string "awk '/MemTotal/ {print$2}' /proc/meminfo")))
#+end_src

** Disable package-enable-at-startup
#+begin_quote
Package initialize occurs automatically, before =user-init-file= is loaded, but after =early-init-file=. We handle package initialization, so we must prevent Emacs from doing it early!
#+end_quote

Prevent =package.el= loading packages prior to their init-file loading.
While it is technically possible to use both =package.el= and =straight.el= at the same time, there is no real reason to, and it might result in oddities like packages getting loaded more than once.
#+begin_src emacs-lisp
  (setq package-enable-at-startup nil)
#+end_src

Prevent Emacs loading outdatet packages.
#+begin_src emacs-lisp
  (setq load-prefer-newer t)
#+end_src

** Unset file-name-handler-alist
Every file opened and loaded by Emacs will run through this list to check for a proper handler for the file, but during startup, it won’t need any of them.
#+begin_src emacs-lisp
  (defvar file-name-handler-alist-original file-name-handler-alist)
  (setq file-name-handler-alist nil)
#+end_src

** Disable unnecessary interfaces.
It will be faster to disable them here before they've been initialized.
#+begin_src emacs-lisp
  (setq-default
   default-frame-alist
   '((horizontal-scroll-bars . nil)       ; No horizontal scroll-bars
     (left-fringe . 10)                   ; Thin left fringe
     (menu-bar-lines . 0)                 ; No menu bar
     (right-divider-width . 1)            ; Thin vertical window divider
     (right-fringe . 10)                  ; Thin right fringe
     (tool-bar-lines . 0)                 ; No tool bar
     (vertical-scroll-bars . nil)))       ; No vertical scroll-bars
#+end_src

** Set Cache directory
Change the user-emacs-directory to keep unwanted things out of ~~/.config/emacs~.
#+BEGIN_SRC emacs-lisp
  (setq user-emacs-directory (expand-file-name "~/.cache/emacs/")
        url-history-file (expand-file-name "url/history" user-emacs-directory))
  #+END_SRC

Set the right directory to store the native comp cache.
#+BEGIN_SRC emacs-lisp
  (when (fboundp 'startup-redirect-eln-cache)
    (startup-redirect-eln-cache
     (convert-standard-filename
      (expand-file-name  "var/eln-cache/" user-emacs-directory))))
  #+END_SRC

** Old init.el file
This snippet is no longer active!
#+html: <details><summary>Old init.el</summary>
#+begin_src emacs-lisp :tangle no
  (defvar my-init-el-start-time (current-time) "Time when init.el was started")
  (setq my-user-emacs-directory "~/.emacs.d/")
  
  ;; Bootstrap straight.el
  (defvar bootstrap-version)
  (let ((bootstrap-file
         (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
        (bootstrap-version 5))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
          (url-retrieve-synchronously
           "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
           'silent 'inhibit-cookies)
        (goto-char (point-max))
        (eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))
  
  ;; Always use straight to install on systems other than Linux
  (setq straight-use-package-by-default t)
  
  ;; Use straight.el for use-package expressions
  (straight-use-package 'use-package)
  
  ;; Load the helper package for commands like `straight-x-clean-unused-repos'
  (require 'straight-x)
  
  (defun ma/org-mode-setup ()
    (org-indent-mode)
    (variable-pitch-mode 1)
    (auto-fill-mode 0)
    (visual-line-mode 1)
    (setq evil-auto-indent nil))
  
  (use-package org
    :hook (org-mode . ma/org-mode-setup)
    :config
    (setq org-ellipsis " ▾")
    (ma/org-font-setup))
  
  ;; =======================================================================================
  ;; The init.el file looks for "config.org" and tangles its elisp blocks (matching
  ;; the criteria described below) to "config.el" which is loaded as Emacs configuration.
  ;; Inspired and copied from: http://www.holgerschurig.de/en/emacs-init-tangle/
  ;; As of 2021-02-05, the Domain "holgerschurig.de" doesn't exist any more.
  ;; Visit archived page on https://archive.org/search.php?query=http%3A%2F%2Fwww.holgerschurig.de%2Fen%2Femacs-init-tangle%2F
  ;; =======================================================================================
  
  ;; from: http://stackoverflow.com/questions/251908/how-can-i-insert-current-date-and-time-into-a-file-using-emacs
  (defvar current-date-time-format "%a %b %d %Y-%m-%dT%H:%M:%S "
    "Format of date to insert with `insert-current-date-time' func
  See help of `format-time-string' for possible replacements")
  
  ;; from: http://stackoverflow.com/questions/251908/how-can-i-insert-current-date-and-time-into-a-file-using-emacs
  (defvar current-time-format "%a %H:%M:%S"
    "Format of date to insert with `insert-current-time' func.
  Note the weekly scope of the command's precision.")
  
  (defun my-tangle-config-org ()
    "This function will write all source blocks from =config.org= into =config.el= that are ...
  - not marked as =tangle: no=
  - doesn't have the TODO state =DISABLED=
  - have a source-code of =emacs-lisp="
    (require 'org)
    (let* ((body-list ())
           (output-file (concat my-user-emacs-directory "config.el"))
           (org-babel-default-header-args (org-babel-merge-params org-babel-default-header-args
                                                                  (list (cons :tangle output-file)))))
      (message "—————• Re-generating %s …" output-file)
      (save-restriction
        (save-excursion
          (org-babel-map-src-blocks (concat my-user-emacs-directory "config.org")
            (let* (
                   (org_block_info (org-babel-get-src-block-info 'light))
                   ;;(block_name (nth 4 org_block_info))
                   (tfile (cdr (assq :tangle (nth 2 org_block_info))))
                   (match_for_TODO_keyword)
                   )
              (save-excursion
                (catch 'exit
                  ;;(when (string= "" block_name)
                  ;;  (message "Going to write block name: " block_name)
                  ;;  (add-to-list 'body-list (concat "message(\"" block_name "\")"));; adding a debug statement for named blocks
                  ;;  )
                  (org-back-to-heading t)
                  (when (looking-at org-outline-regexp)
                    (goto-char (1- (match-end 0))))
                  (when (looking-at (concat " +" org-todo-regexp "\\( +\\|[ \t]*$\\)"))
                    (setq match_for_TODO_keyword (match-string 1)))))
              (unless (or (string= "no" tfile)
                          (string= "DISABLED" match_for_TODO_keyword)
                          (not (string= "emacs-lisp" lang)))
                (add-to-list 'body-list (concat "\n\n;; #####################################################################################\n"
                                                "(message \"config • " (org-get-heading) " …\")\n\n")
                             )
                (add-to-list 'body-list body)
                ))))
        (with-temp-file output-file
          (insert ";; ============================================================\n")
          (insert ";; Don't edit this file, edit config.org' instead ...\n")
          (insert ";; Auto-generated at " (format-time-string current-date-time-format (current-time)) " on host " system-name "\n")
          (insert ";; ============================================================\n\n")
          (insert (apply 'concat (reverse body-list))))
        (message "—————• Wrote %s" output-file))))
  
  
  ;; following lines are executed only when my-tangle-config-org-hook-func()
  ;; was not invoked when saving config.org which is the normal case:
  (let ((orgfile (concat my-user-emacs-directory "config.org"))
        (elfile (concat my-user-emacs-directory "config.el"))
        (gc-cons-threshold most-positive-fixnum))
    (when (or (not (file-exists-p elfile))
              (file-newer-than-file-p orgfile elfile))
      (my-tangle-config-org)
      ;;(save-buffers-kill-emacs);; TEST: kill Emacs when config has been re-generated due to many issues when loading newly generated config.el
      )
    (load-file elfile))
  
  ;; when config.org is saved, re-generate config.el:
  (defun my-tangle-config-org-hook-func ()
    (when (string= "config.org" (buffer-name))
      (let ((orgfile (concat my-user-emacs-directory "config.org"))
            (elfile (concat my-user-emacs-directory "config.el")))
        (my-tangle-config-org))))
  (add-hook 'after-save-hook 'my-tangle-config-org-hook-func)
  
  
  (message "→★ loading init.el in %.2fs" (float-time (time-subtract (current-time) my-init-el-start-time)))
#+end_src
#+html: </details>

* Basic System Configuraten (=init.el=)
Silence compiler warnings as they can be pretty disruptive
#+begin_src emacs-lisp
  (setq native-comp-async-report-warnings-errors nil)
#+end_src

** Packagemanagement with straight.el
Init-file and version lockfiles as the sole source of truth.
No persistent state kept elsewhere.
100% reproducible package management, accounting for changes in packages, recipe repositories, configuration, and the package manager itself.
#+begin_quote
Note: =straight.el= supports a minimum version of Emacs 25.1, and works on macOS, Windows, and most flavors of Linux. You must install Git in order to use =straight.el=.
#+end_quote

=straight.el= determines your package management configuration from two, and only two, sources: the contents of your init-file, and your version lockfiles.
To write the current revisions of all your packages into version lockfiles, run =M-x straight-freeze-versions=.
This will first check that =straight.el= has an up-to-date account of what packages are installed by your init-file, then ensure that all your local changes are pushed (remember, we are aiming for perfect reproducibility!).

For updading the packages run =M-x straight-pull-package= to get the latest version of a given package (or =M-x straight-pull-all= to update everything), and then =M-x straight-freeze-versions= to persist the on-disk versions to your lockfile (=~/.emacs.d/straight/versions/default.el= by default).
You can run =M-x straight-thaw-versions= at any time to reset on-disk packages to their locked versions, making your config totally reproducible across environments. 

Sometimes it's good to clean up unused repositories if I've removed packages from my configuration.  Use =straight-remove-unused-repos= for this purpose.

Let's bootstrap [[https://github.com/raxod502/straight.el][straight.el]] with:
#+begin_src emacs-lisp
(defvar bootstrap-version)
(let ((bootstrap-file
       (expand-file-name
        "straight/repos/straight.el/bootstrap.el"
        (or (bound-and-true-p straight-base-dir)
            user-emacs-directory)))
      (bootstrap-version 7))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
        (url-retrieve-synchronously
         "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
         'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  (load bootstrap-file nil 'nomessage))
#+end_src

Load the helper package for commands like `straight-x-clean-unused-repos'
#+begin_src emacs-lisp
  (require 'straight-x)
#+end_src

If [[https://github.com/watchexec/watchexec][watchexec]] and [[https://www.python.org/][Python 3]] are installed, use file watchers to detect package modifications.
This saves time at startup.
Otherwise, use the ever-reliable =find(1)=.
#+begin_src emacs-lisp
  (if (and (executable-find "watchexec")
           (executable-find "python3"))
      (setq straight-check-for-modifications '(watch-files find-when-checking))
    (setq straight-check-for-modifications
          '(find-at-startup find-when-checking)))
#+end_src

*** Integration with use-package
=use-package= is a macro that provides convenient syntactic sugar for many common tasks related to installing and configuring Emacs packages.
Of course, it does not actually install the packages, but instead defers to a package manager, =like straight.el= (which comes with =use-package= integration by default).

To use =use-package=, first install it with =straight.el=:
#+begin_src emacs-lisp
  (straight-use-package 'use-package)
#+end_src

Use =straight.el= for =use-package= expressions:
#+begin_src emacs-lisp
  (setq straight-use-package-by-default t)    
#+end_src

Like =use-package=, but with =straight-use-package-by-default= disabled.
NAME and ARGS are as in =use-package=.
[[https://github.com/raxod502/radian/blob/58ba58bd827e719c0eeb3d3c996d59cf4d00acd5/emacs/radian.el#L542][use-feature]] macro by [[*Credits][Radox502]]:
#+begin_src emacs-lisp
  (defmacro use-feature (name &rest args)
    (declare (indent defun))
    `(use-package ,name
       :straight nil
       ,@args))
#+end_src

** Change default settings
#+BEGIN_SRC emacs-lisp
  (setq-default
   ad-redefinition-action 'accept         ; Silence warnings for redefinition
   auto-save-list-file-prefix nil         ; Prevent tracking for auto-saves
   cursor-in-non-selected-windows nil     ; Hide the cursor in inactive windows
   cursor-type '(hbar . 2)                ; Underline-shaped cursor
   custom-unlispify-menu-entries nil      ; Prefer kebab-case for titles
   custom-unlispify-tag-names nil         ; Prefer kebab-case for symbols
   delete-by-moving-to-trash t            ; Delete files to trash
   ;; fill-column 80                        ; Set width for automatic line breaks
   help-window-select t                   ; Focus new help windows when opened
   indent-tabs-mode nil                   ; Stop using tabs to indent
   inhibit-startup-screen t               ; Disable start-up screen
   initial-scratch-message ""             ; Empty the initial *scratch* buffer
   mouse-yank-at-point t                  ; Yank at point rather than pointer
   recenter-positions '(5 top bottom)     ; Set re-centering positions
   scroll-conservatively 101              ; Avoid recentering when scrolling far
   scroll-margin 2                        ; Add a margin when scrolling vertically
   select-enable-clipboard t              ; Merge system's and Emacs' clipboard
   sentence-end-double-space nil          ; Use a single space after dots
   show-help-function nil                ; Disable help text everywhere
   tab-always-indent 'complete            ; Tab indents first then tries completions
   tab-width 4                            ; Smaller width for tab characters
   uniquify-buffer-name-style 'forward    ; Uniquify buffer names
   warning-minimum-level :error           ; Skip warning buffers
   window-combination-resize t            ; Resize windows proportionally
   x-stretch-cursor t)                    ; Stretch cursor to the glyph width
  (delete-selection-mode 1)               ; Replace region when inserting text
  (fset 'yes-or-no-p 'y-or-n-p)           ; Replace yes/no prompts with y/n
  (global-subword-mode 1)                 ; Iterate through CamelCase words
  (mouse-avoidance-mode 'exile)           ; Avoid collision of mouse with point
  (put 'downcase-region 'disabled nil)    ; Enable downcase-region
  (put 'upcase-region 'disabled nil)      ; Enable upcase-region
  (set-default-coding-systems 'utf-8)     ; Default to utf-8 encoding
  (scroll-bar-mode -1)        ; Disable visible scrollbar
  (tool-bar-mode -1)          ; Disable the toolbar
  ;;(tooltip-mode -1)           ; Disable tooltips
  (set-fringe-mode 10)        ; Give some breathing room
  (menu-bar-mode -1)          ; Disable the menu bar
  (save-place-mode 1)         ; Save the last cursor position

  ;; Set up the visible bell
  (setq visible-bell t)

#+END_SRC

Global line numbering is helpful, but not useful for all modes.
#+begin_src emacs-lisp
  ;; Show line numbers
  (column-number-mode)
  (global-display-line-numbers-mode t)

  ;; Disable line numbers for some modes
  (dolist (mode'(org-mode-hook
                 term-mode-hook
                 shell-mode-hook
                 eshell-mode-hook
                 treemacs-mode-hook
                 mu4e-mode-hook))
    (add-hook mode (lambda () (display-line-numbers-mode 0))))
#+END_SRC

The =global-auto-revert-mode= will make Emacs watch the files for all open buffers for changes on disk and it will autmatically refresh those buffers if they don't have unsaved changes!
The same applys to =global-auto-revert-non-file-buffers= for directories.
#+begin_src emacs-lisp
  (global-auto-revert-mode 1)
  (setq global-auto-revert-non-file-buffers 1)
#+end_src

** Keep emacs.d clean
The default paths used to store configuration files and persistent data are not consistent across Emacs packages.
This isn't just a problem with third-party packages but even with built-in packages.

Some packages put these files directly in =user-emacs-directory= or ~$HOME~ or in a subdirectory of either of the two or elsewhere.
Furthermore sometimes file names are used that don't provide any insight into what package might have created them.

[[https://github.com/emacscollective/no-littering][No-littering]] sets out to fix this by changing the values of path variables to put configuration files in =no-littering-etc-directory= (defaulting to "etc/" under =user-emacs-directory=, thus usually "~/.config/emacs/etc/") and persistent data files in =no-littering-var-directory= (defaulting to "var/" under =user-emacs-directory=, thus usually "~/.emacs.d/var/"), and by using descriptive file names and subdirectories when appropriate.
This is similar to a color-theme; a "path-theme" if you will.
#+begin_src emacs-lisp
  (use-package no-littering
  :config
  ;; Theme locations where backups of various sorts are created
  (no-littering-theme-backups))
#+end_src

Disable =customize-*= routine and redirect the writing to =/dev/null=.
#+BEGIN_SRC emacs-lisp
  (setq-default custom-file null-device)
#+END_SRC

* User Interface
** Dashboard
[[https://github.com/emacs-dashboard/emacs-dashboard][Emacs Dashboard]] - An extensible emacs startup screen showing you what’s most important.
#+BEGIN_SRC emacs-lisp
  (use-package dashboard
    :ensure t
    :config
    (dashboard-setup-startup-hook))
    (setq
    initial-buffer-choice (lambda () (get-buffer-create dashboard-buffer-name))
    dashboard-startup-banner 'logo
    dashboard-center-content t
    dashboard-vertically-center-content t
    dashboard-set-navigator t
    dashboard-set-init-info t
    dashboard-projects-backend 'projectile
    dashboard-items '((recents  . 5)
                      (bookmarks . 5)
                      (projects . 5)
                      (agenda . 5)
                      (registers . 5)))
#+END_SRC

** Doom Theme
[[https://github.com/hlissner/emacs-doom-themes][Doom Theme]] - A theme megapack for GNU Emacs, inspired by community favorites.
I use the custom =stylix=-enabled =mustache= theme template from [[https://github.com/librephoenix/nixos-config/blob/7a5b01ab7de1127a9ba13f88c39e4bccbc73f6ac/user/app/doom-emacs/themes/doom-stylix-theme.el.mustache][librephoenix]].
#+BEGIN_SRC emacs-lisp
  (setq custom-theme-directory "~/.config/emacs/themes")
  (use-package doom-themes :defer t)
  :config
  ;; Global settings (defaults)
  (setq doom-themes-enable-bold t    ; if nil, bold is universally disabled
        doom-themes-enable-italic t) ; if nil, italics is universally disabled
  ;;(load-theme 'doom-palenight t)
  (load-theme 'doom-stylix t)
  ;; Enable flashing mode-line on errors
  (doom-themes-visual-bell-config)
  ;; Enable custom neotree theme (all-the-icons must be installed!)
  ;; (doom-themes-neotree-config)
  ;; or for treemacs users
  ;; (setq doom-themes-treemacs-theme "doom-atom") ; use "doom-colors" for less minimal icon theme
  ;; (doom-themes-treemacs-config)
  ;; Corrects (and improves) org-mode's native fontification.
  (doom-themes-org-config)
    #+END_SRC

=doom-modeline= is a fancy and fast mode-line inspired by minimalism design
NOTE: The first time you load your configuration on a new machine, you'll need to run the following command interactively so that mode line icons display correctly =M-x nerd-icons-install-fonts=.
#+BEGIN_SRC emacs-lisp
  (use-package nerd-icons)
  (use-package doom-modeline
    :ensure t
    ;;:init (doom-modeline-mode 1)
    :hook (after-init . doom-modeline-mode)
    :hook (doom-modeline-mode . size-indication-mode)
    :hook (doom-modeline-mode . column-number-mode)
    :init
    (setq doom-modeline-height 25
          ;;doom-modeline-bar-width 6
          doom-modeline-bar-width 3
          doom-modeline-github nil
          doom-modeline-mu4e nil
          doom-modeline-persp-name nil
          doom-modeline-minor-modes nil
          doom-modeline-major-mode-icon nil
          doom-modeline-buffer-file-name-style 'relative-from-project
          doom-modeline-buffer-encoding 'nondefault)
    :config
    (defvar mouse-wheel-down-event nil)
    (defvar mouse-wheel-up-event nil))
#+END_SRC
    
* Key Binding Configuration
** Make ESC quit prompts
#+BEGIN_SRC emacs-lisp
  (global-set-key (kbd "<escape>") 'keyboard-escape-quit)
#+END_SRC

This keybinding is overridden by evil.
To activate an alternate =universal-argument= binding enable the following codeblock.
#+BEGIN_SRC amacs-lisp :tangle no
(global-set-key (kbd "C-M-u") 'universal-argument)
#+END_SRC

** Change Leader with =general.el=
With the help of =general.el=, it is easy to manage key combinations and also serves as a wrapper for =wich-key=.
- =:ignore t= and =:which-key= bind nothing but give a description.
#+BEGIN_SRC emacs-lisp
  (use-package general
    :config
    (general-create-definer ma/leader-key-def
      :keymaps '(normal insert visual emacs)
      :prefix "SPC"
      :global-prefix "C-SPC")

    (ma/leader-key-def
      "t"  '(:ignore t :which-key "toggles")
      "tt" '(load-theme :which-key "choose theme")))
#+END_SRC

** Evil mode
- =C-z= Toggle =emacs-mode= (disable evil  keybindings)
- =C-g= Expand the default emacs "Exit" function with evils "normal" state
#+BEGIN_SRC emacs-lisp
  (defun ma/evil-hook ()
    (dolist (mode '(custom-mode
                    eshell-mode
                    git-rebase-mode
                    erc-mode
                    circe-server-mode
                    circe-chat-mode
                    circe-query-mode
                    sauron-mode
                    term-mode))
      (add-to-list 'evil-emacs-state-modes mode)))
  
  (use-package evil
    :init
    (setq evil-want-integration t)
    (setq evil-want-keybinding nil)
    (setq evil-want-C-u-scroll t)
    (setq evil-want-C-i-jump nil)
    (setq evil-respect-visual-line-mode t)
    (setq evil-undo-system 'undo-tree)
    :config
    (add-hook 'evil-mode-hook 'ma/evil-hook)
    (evil-mode 1)
    (define-key evil-insert-state-map (kbd "C-g") 'evil-normal-state)
    (define-key evil-insert-state-map (kbd "C-h") 'evil-delete-backward-char-and-join)
  
    ;; Use visual line motions even outside of visual-line-mode buffers
    (evil-global-set-key 'motion "j" 'evil-next-visual-line)
    (evil-global-set-key 'motion "k" 'evil-previous-visual-line)
  
    (evil-set-initial-state 'messages-buffer-mode 'normal)
    (evil-set-initial-state 'dashboard-mode 'normal))

  (use-package evil-collection
    :after evil
    :config
    (evil-collection-init))
#+END_SRC

** Helpful
Better help funtions with =helpful=
#+BEGIN_SRC emacs-lisp 
  (use-package helpful
    :ensure t
    :bind
    ([remap describe-function] . helpful-function)
    ([remap describe-symbol] . helpful-symbol)
    ([remap describe-variable] . helpful-variable)
    ([remap describe-command] . helpful-command)
    ([remap describe-key] . helpful-key))
#+END_SRC

Use =SPC e b= to run =eval-buffer= or =SPC e r= to run =eval-region= in the highlighted block. 
#+BEGIN_SRC emacs-lisp 
  (ma/leader-key-def
    "e"  '(:ignore t :which-key "eval")
    "eb" '(eval-buffer :which-key "eval buffer"))

  (ma/leader-key-def
    :keymaps '(visual)
    "er" '(eval-region :which-key "eval region"))
#+END_SRC

** Preserve Minibuffer History with =savehist=
#+BEGIN_SRC emacs-lisp 
  (use-package savehist
    :init
    (setq history-length 25)
    (savehist-mode 1))
#+END_SRC

** Vertico
#+html: <details><summary>Vertico Helper Funktions</summary>
Copied from Doom Emacs [[https://github.com/doomemacs/doomemacs/blob/master/modules/completion/vertico/autoload/vertico.el][Vertico]] Module.  
#+BEGIN_SRC emacs-lisp
  (defun +vertico/enter-or-preview ()
    "Enter directory or embark preview on current candidate."
    (interactive)
    (when (> 0 vertico--index)
      (user-error "No vertico session is currently active"))
    (if (and (let ((cand (vertico--candidate)))
               (or (string-suffix-p "/" cand)
                   (and (vertico--remote-p cand)
                        (string-suffix-p ":" cand))))
             (not (equal vertico--base ""))
             (eq 'file (vertico--metadata-get 'category)))
        (vertico-insert)
      (condition-case _
          (+vertico/embark-preview)
        (user-error (vertico-directory-enter)))))

  (defun +vertico/embark-preview ()
    "Previews candidate in vertico buffer, unless it's a consult command"
    (interactive)
    (unless (bound-and-true-p consult--preview-function)
      (if (fboundp 'embark-dwim)
          (save-selected-window
            (let (embark-quit-after-action)
              (embark-dwim)))
        (user-error "Embark not installed, aborting..."))))
#+END_SRC
#+html: </details>

#+BEGIN_SRC emacs-lisp 
  (use-package vertico
    :demand t
    :bind (:map vertico-map
                ("C-j" . vertico-next)
                ("C-M-j" . vertico-next-group)
                ("C-k" . vertico-previous)
                ("C-M-k" . vertico-previous-group)
                ("C-f" . vertico-exit-input)
                ("C-h" . vertico-directory-up)
                ("C-l" . +vertico/enter-or-preview)
                :map minibuffer-local-map
                ("M-h" . vertico-directory-up))
    :custom
    (vertico-resize nil)
    (vertico-count 17)
    (vertico-cycle t)

    :config
    (require 'vertico-directory)
    (vertico-mode)
    (setq-default completion-in-region-function
                  (lambda (&rest args)
                    (apply (if vertico-mode
                               #'consult-completion-in-region
                             #'completion--in-region)
                           args))))

  (use-package corfu
    :bind (:map corfu-map
                ("C-j" . corfu-next)
                ("C-k" . corfu-previous)
                ("TAB" . corfu-insert)
                ([tab] . corfu-insert)
                ("C-f" . corfu-insert))
    :custom
    (corfu-cycle t)
    (corfu-auto t)
    (corfu-preview-current nil)
    (corfu-quit-at-boundary t)
    (corfu-quit-no-match t)

    :config
    (global-corfu-mode 1))

  (use-package kind-icon
    :after corfu
    :custom (kind-icon-default-face 'corfu-default)
    :config
    (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter))

  (use-package orderless
    :demand t
    :config
    (orderless-define-completion-style orderless+initialism
      (orderless-matching-styles '(orderless-initialism
                                   orderless-literal
                                   orderless-regexp)))

    (setq completion-styles '(orderless)
          completion-category-defaults nil
          orderless-matching-styles '(orderless-literal orderless-regexp)
          completion-category-overrides
          '((file (styles partial-completion)))))

  (use-package wgrep
    :after consult
    :hook (grep-mode . wgrep-setup))

  (use-package consult
    :demand t
    :bind (
           ([remap bookmark-jump] . consult-bookmark)
           ([remap evil-show-marks] . consult-mark)
           ([remap evil-show-registers] . consult-register)
           ([remap goto-line] . consult-goto-line)
           ([remap imenu] . consult-imenu)
           ([remap Info-search] . consult-info)
           ([remap locate] . consult-locate)
           ([remap load-theme] . consult-theme)
           ([remap man] . consult-man)
           ([remap recentf-open-files] . consult-recent-file)
           ([remap switch-to-buffer] . consult-buffer)
           ([remap switch-to-buffer-other-window] . consult-buffer-other-window)
           ([remap switch-to-buffer-other-frame] . consult-buffer-other-frame)
           ([remap yank-pop] . consult-yank-pop)
           ("C-s" . consult-line)
           ("C-M-l" . consult-imenu)
           ("C-M-j" . consult-buffer)
           ("C-x C-b" . consult-buffer)
           :map minibuffer-local-map
           ("C-r" . consult-history))
    :custom
    (completion-in-region-function #'consult-completion-in-region))

  (use-package consult-dir
    :bind (("C-x C-d" . consult-dir)
           :map vertico-map
           ("C-x C-d" . consult-dir)
           ("C-x C-j" . consult-dir-jump-file))

    :custom
    (consult-dir-project-list-function nil))

  (use-package marginalia
    :after vertico
    :custom
    (marginalia-annotators '(marginalia-annotators-heavy
                             marginalia-annotators-light
                             nil))
    :config
    (marginalia-mode))

  (use-package embark
    :after vertico
    :bind (("C-." . embark-act)
           ("M-." . embark-dwim)
           :map minibuffer-local-map
           ("C-d" . embark-act)
           :map embark-region-map
           ("D" . denote-region))

    :config
    ;; Remove the mixed indicator to prevent the popup from being displayed
    ;; automatically
    (delete #'embark-mixed-indicator embark-indicators)
    (add-to-list 'embark-indicators 'embark-minimal-indicator)

    ;; Use Embark to show command prefix help
    (setq prefix-help-command #'embark-prefix-help-command))

  (use-package embark-consult
    :after embark)

  (ma/leader-key-def
    "f"   '(:ignore t :which-key "files")
    "ff"  '(find-file :which-key "open file")
    "C-f" 'find-file
    "fr"  '(recentf :which-key "recent files")
    "fR"  '(revert-buffer :which-key "revert file")) 
#+END_SRC

* Development
** Project Management
*** Projectile
#+BEGIN_SRC emacs-lisp
  (use-package projectile
    :diminish projectile-mode
    :config
    (projectile-mode)
    (when
        (require 'magit nil t)
      (mapc #'projectile-add-known-project
            (mapcar #'file-name-as-directory
                    (magit-list-repos)))
      ;; Optionally write to persistent 'projectile-known-projects-file'
      (projectile-save-known-projects))
    :bind-keymap
    ("C-c p" . projectile-command-map))

  (ma/leader-key-def
    "p"  '(:ignore t :which-key "projectile")
    "pf"  'projectile-find-file
    "ps"  'projectile-switch-project
    "pF"  'consult-ripgrep
    "pb"  'consult-project-buffer
    "pc"  'projectile-compile-project
    "pd"  'projectile-dired)
#+END_SRC

Configure =magit-repository-directories= (which see) to include the desired directories.
Note that each entry can be associated with a subdirectory depth.
If you organise all your projects as subdirectories of a select few parent directories, then only the parent directories need be added to =magit-repository-directories=, with the corresponding search depth.
After Projectile is loaded, you can add all repositories reported by Magit to =projectile-known-projects=.
Foud at [[https://emacs.stackexchange.com/questions/32634/how-can-the-list-of-projects-used-by-projectile-be-manually-updated][Stackexchange]].

*** Magit
#+BEGIN_SRC emacs-lisp
  (use-package magit
    :bind ("C-M-;" . magit-status)
    :commands (magit-status magit-get-current-branch)
    :custom
    (magit-display-buffer-function #'magit-display-buffer-same-window-except-diff-v1))
    (setq magit-repository-directories
          '(;; Directory containing project root directories
            ("~/git/"      . 1)))

  (use-package magit-todos
    :after magit
    :config
    ;; (setq magit-todos-keyword-suffix "\\(?:([^)]+)\\)?:?") ; make colon optional
    (magit-todos-mode 1))

  (ma/leader-key-def
    "g"   '(:ignore t :which-key "git")
    "gs"  'magit-status
    "gd"  'magit-diff-unstaged
    "gc"  'magit-branch-or-checkout
    "gl"   '(:ignore t :which-key "log")
    "glc" 'magit-log-current
    "glf" 'magit-log-buffer-file
    "gb"  'magit-branch
    "gP"  'magit-push-current
    "gp"  'magit-pull-branch
    "gf"  'magit-fetch
    "gF"  'magit-fetch-all
    "gr"  'magit-rebase)
#+END_SRC

*** Direnv
It works by invoking =direnv= to obtain the environment for the current file, then updating the emacs variables =process-environment= and =exec-path=.
The result is that programs started from within emacs, such as inferior shells, linters, compilers, and test runners, will be looked up in the correct =$PATH=, and will be started with the correct environment variables set.
#+BEGIN_SRC emacs-lisp
(use-package direnv
 :config
 (direnv-mode))
#+END_SRC

** Languages
*** Language Servers
- lsp-mode
Install =lsp-mode= and set the memory limit to 80% of the available memory (described as =total-memory= in [[*Garbage Collection][Garbage Collection]]).
#+BEGIN_SRC emacs-lisp
  (use-package lsp-mode
    :commands (lsp lsp-deferred)
    :init
    (setq lsp-memory-limit (* 0.8 total-memory 1024)) ; Memory in KB convert to bytes
    (setq lsp-keymap-prefix "C-c l")
    ;; Disable features that have great potential to be slow.
    (setq lsp-enable-folding nil
          lsp-enable-text-document-color nil)
    (setq lsp-enable-on-type-formatting nil)
    ;; Make breadcrumbs opt-in; they're redundant with the modeline and imenu
    (setq lsp-headerline-breadcrumb-enable nil)
    ;; Explicitly tell lsp to use flymake; Lsp will default to flycheck if found
    ;; even if its a dependency
    (setq lsp-diagnostics-provider :flymake)
    :config
    (lsp-enable-which-key-integration t))
#+END_SRC

- lsp-ui
#+BEGIN_SRC emacs-lisp
(use-package lsp-ui
  :hook (lsp-mode . lsp-ui-mode)
  :custom
  (lsp-ui-doc-position 'bottom))
#+END_SRC

- lsp-treemacs
#+BEGIN_SRC emacs-lisp
  (use-package lsp-treemacs
    :after lsp)

  (setq lsp-treemacs-deps-position-params '((side . right)
                                            (slot . 1)
                                            (window-width . 35)))

  (setq lsp-treemacs-symbols-position-params '((side . right)
                                               (slot . 2)
                                               (window-width . 35)))
#+END_SRC

- consult-lsp
#+BEGIN_SRC emacs-lisp
(use-package consult-lsp
  :after lsp)
#+END_SRC

-company-mode
#+BEGIN_SRC emacs-lisp
  (use-package company
    :after lsp-mode
    :hook (lsp-mode . company-mode)
    :bind (:map company-active-map
           ("<tab>" . company-complete-selection))
          (:map lsp-mode-map
           ("<tab>" . company-indent-or-complete-common))
    :custom
    (company-minimum-prefix-length 1)
    (company-idle-delay 0.0))

  (use-package company-box
    :hook (company-mode . company-box-mode))
#+END_SRC

*** Nix
TODO: Set only if memory is lower than 12GB?!
#+BEGIN_SRC emacs-lisp
  (use-package nix-mode
    :mode ("\\.nix\\'" "\\.nix.in\\'")
    :hook (nix-mode . lsp-deferred)
    :config)

  (setq lsp-nix-nil-auto-eval-inputs nil)
#+END_SRC

* Features
** Parentheses
Highlights delimiters (parentheses, brackets or braces).
#+BEGIN_SRC emacs-lisp 
  (use-package rainbow-delimiters
    :hook (prog-mode . rainbow-delimiters-mode))
#+END_SRC

Enable auto close bracket insertion.
#+BEGIN_SRC emacs-lisp
  (use-package smartparens
    :bind
    ("<M-backspace>" . sp-unwrap-sexp)
    ("<M-left>" . sp-forward-barf-sexp)
    ("<M-right>" . sp-forward-slurp-sexp)
    ("<M-S-left>" . sp-backward-slurp-sexp)
    ("<M-S-right>" . sp-backward-barf-sexp)
    :hook
    (after-init . smartparens-global-mode)
    :custom
    (sp-highlight-pair-overlay t)
    (sp-highlight-wrap-overlay t)
    (sp-highlight-wrap-tag-overlay t)
    :config
    (require 'smartparens-config))
#+END_SRC

** Undotree
#+BEGIN_SRC emacs-lisp
  (use-package undo-tree
    :init
    (global-undo-tree-mode 1))
#+END_SRC

** Qualitiy of Life
Colorize colors as text with their value.
#+BEGIN_SRC emacs-lisp
  (use-package rainbow-mode
    :hook
    (prog-mode . rainbow-mode)
    :custom
    (rainbow-x-colors nil))
#+END_SRC

An unobtrusive way to trim spaces from end of line.
#+BEGIN_SRC emacs-lisp
  (use-package ws-butler
    :hook ((prog-mode . ws-butler-mode)
           (text-mode . ws-butler-mode)))
#+END_SRC

[[https://github.com/justbur/emacs-which-key][Which-key]] is great for getting an overview of what keybindings are available based on the prefix keys you entered.
Learned about this one from Spacemacs.
#+BEGIN_SRC emacs-lisp
  (use-package which-key
    :init (which-key-mode)
    :diminish which-key-mode
    :config
    (setq which-key-idle-delay 0.5))
#+END_SRC

* Runtime Performance
- Garbage collection with =gcmh-mode=
#+BEGIN_QUOTE
The =emacs-startup-hook= runs later than the =after-init-hook=.
One key difference is that there may be command-line options processed after the after-init-hook and before the emacs-startup-hook.
(Command-line options are handled in multiple phases, with some being processed right away and some after init files have been loaded.)
#+END_QUOTE

Enforce a sneaky Garbage Collection strategy to minimize GC interference with the activity.
During normal use a high GC threshold is set.
When idling GC is triggered and a low threshold is set.
#+BEGIN_SRC emacs-lisp
  (use-package gcmh
    :config
    (setopt garbage-collection-messages t)
    ;; (setopt gcmh-verbose t)
    (add-hook 'emacs-startup-hook #'gcmh-mode))
#+END_SRC
